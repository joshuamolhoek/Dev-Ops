# Adding an agent node to and RKE2 cluster

## Step 1 - Log in to the server node

To add an agent node to the RKE2 cluster, we first need to token generated by the RKE2 server.

The node token is located in the file /var/lib/rancher/rke2/server/node-token

**COPY THE NODE-TOKEN and SAVE IT FOR LATER**

- We will use it for the `config.yaml` on the agent node.

## Step 2 - Move the air gapped dependencies to the agent node

Move all the air gapped dependencies we downloaded for the server to the agent node in `/usr/lib/rke2/scripts/install` and place them in `/usr/lib/rke2/scripts/install` on the Agent node.

## Step 3 - Log in to the Agent node

## Step 4 - Prepare the agent node

- Set SELinux to permissive
- Turn off firewalld
- Check set the NTP server in the /etc/chrony.conf
- Add the network manager config file for the CNI

## Create the registries.yaml

Use the same registries.yaml we used for our server node

## Create the config.yaml

Add the following information to your config.yaml

Use the node token you pulled from the server node in **Step 1**

```yaml
server: https://${vip_hostname}.${domain}:9345
token: ${node_token}
```

## Run the RKE2 Agent install script provided by rancher

The `install.sh` file we downloaded from Rancher will also install the Agent service if we tell it to using the following command

```shell
INSTALL_RKE2_TYPE="agent" /usr/lib/rke2/scripts/install/install.sh
```

Run the Agent service.

```shell
systemctl enable --now rke2-agent
```

## Watch the logs

You may now watch the journal logs on both the Agent and the Server to watch the installation take place

## From the Server node

kubectl commands need to be run on a server node.

When the agent is installed, the output of `kubectl get nodes` will show `Ready` once it's complete.
```